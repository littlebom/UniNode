version: "3.8"

services:
  # ── Database ──
  postgres-node:
    image: timescale/timescaledb:latest-pg16
    container_name: node-postgres
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: uninode
      POSTGRES_PASSWORD: password
      POSTGRES_DB: uninode_tu
    volumes:
      - node-pg-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U uninode"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - node-db-net

  # ── Cache / Queue ──
  redis-node:
    image: redis:7-alpine
    container_name: node-redis
    ports:
      - "6380:6379"
    volumes:
      - node-redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - node-db-net

  # ── Vault (Dev Mode) ──
  vault-node:
    image: hashicorp/vault:1.17
    container_name: node-vault
    ports:
      - "8201:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: dev-root-token
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: ["CMD-SHELL", "VAULT_ADDR=http://127.0.0.1:8200 vault status"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - node-db-net

  # ── Vault Init (one-shot) ──
  vault-init:
    image: hashicorp/vault:1.17
    container_name: node-vault-init
    environment:
      VAULT_ADDR: http://vault-node:8200
      VAULT_TOKEN: dev-root-token
    volumes:
      - ./deploy/scripts/vault-init-local.sh:/vault-init.sh:ro
    command: sh /vault-init.sh
    depends_on:
      vault-node:
        condition: service_healthy
    networks:
      - node-db-net

  # ── Migration (one-shot) ──
  migrate-node:
    build:
      context: .
      dockerfile: apps/uni-node/Dockerfile
      target: builder
    container_name: node-migrate
    command: >
      sh -c "cd apps/uni-node && npx typeorm migration:run -d dist/src/data-source.js"
    environment:
      DATABASE_URL: postgresql://uninode:password@postgres-node:5432/uninode_tu
      NODE_ENV: production
    depends_on:
      postgres-node:
        condition: service_healthy
      vault-init:
        condition: service_completed_successfully
    networks:
      - node-db-net

  # ── UniNode API ──
  uni-node:
    build:
      context: .
      dockerfile: apps/uni-node/Dockerfile
    container_name: node-app
    expose:
      - "3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      API_PREFIX: unilink/api/v1
      DATABASE_URL: postgresql://uninode:password@postgres-node:5432/uninode_tu
      REDIS_URL: redis://redis-node:6379
      REDIS_DB: 0
      VAULT_URL: http://vault-node:8200
      VAULT_TOKEN: dev-root-token
      VAULT_SIGNING_KEY_PATH: tu-ac-th
      VAULT_MOUNT_PATH: transit
      JWT_SECRET: local-dev-jwt-secret-must-be-at-least-64-characters-long-for-security
      JWT_EXPIRES_IN: 1h
      NODE_ID: tu.ac.th
      NODE_NAME: มหาวิทยาลัยธรรมศาสตร์
      NODE_NAME_EN: Thammasat University
      NODE_DID: did:web:tu.ac.th
      NODE_DOMAIN: tu.ac.th
      REGISTRY_URL: http://registry-nginx/api/v1
      REGISTRY_NODE_JWT: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJub2RlLXNlcnZpY2U6dHUuYWMudGgiLCJyb2xlIjoibm9kZV9hZG1pbiIsIm5vZGVJZCI6InR1LmFjLnRoIiwibmFtZSI6IlVuaU5vZGUgdHUuYWMudGggU2VydmljZSIsImlhdCI6MTc3MjE3Mjk0NywiZXhwIjoyMDg3NTMyOTQ3fQ.ogTbRh5KY9CGSi80MC1lyRhHWsC5RLEHQDMtaR-ASWg
      AGGREGATE_SYNC_ENABLED: "true"
      AGGREGATE_SYNC_CRON: "0 2 * * *"
      CORS_ORIGINS: http://localhost:3009,http://localhost:3010
      LOG_LEVEL: info
      LOG_FORMAT: json
    depends_on:
      migrate-node:
        condition: service_completed_successfully
      redis-node:
        condition: service_healthy
    networks:
      - node-app-net
      - node-db-net
      - unilink-shared

  # ── UniNode Portal ──
  uni-node-portal:
    build:
      context: .
      dockerfile: apps/uni-node-portal/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost:3008/api/v1
        NEXT_PUBLIC_NODE_API_URL: http://localhost:3009/unilink/api/v1
        NEXT_PUBLIC_NODE_NAME: มหาวิทยาลัยธรรมศาสตร์
        NEXT_PUBLIC_NODE_ID: tu.ac.th
    container_name: node-portal
    expose:
      - "3000"
    environment:
      NODE_ENV: production
      AUTH_TRUST_HOST: "true"
      NEXTAUTH_URL: http://localhost:3009
      NEXTAUTH_SECRET: dev-secret-change-in-production
      NEXT_PUBLIC_NODE_API_URL: http://localhost:3009/unilink/api/v1
      NEXT_PUBLIC_REGISTRY_URL: http://localhost:3008/api/v1
      REGISTRY_AUTH_URL: http://registry-nginx/api/v1
    depends_on:
      - uni-node
    networks:
      - node-app-net
      - unilink-shared

  # ── Nginx Reverse Proxy ──
  nginx-node:
    image: nginx:alpine
    container_name: node-nginx
    ports:
      - "3009:80"
    volumes:
      - ./deploy/docker/nginx/local.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - uni-node
      - uni-node-portal
    networks:
      - node-app-net

volumes:
  node-pg-data:
  node-redis-data:

networks:
  node-app-net:
    driver: bridge
  node-db-net:
    driver: bridge
    internal: true
  unilink-shared:
    external: true
